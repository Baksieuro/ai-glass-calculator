<!-- app/templates/manager_form.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Расчёт изделия</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .item-block { border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; border-radius: 6px; }
        hr { margin: 15px 0; }
        label { display: block; margin-top: 6px; }
        input, select { padding: 4px; margin-top: 3px; width: 200px; }
        h2 { color: #3ba6ff; }
        button { padding: 10px 20px; margin-top: 15px; }
    </style>
</head>
<body>

<h2>Расчёт изделия (панель менеджера)</h2>

<form id="calc-form" action="/manager/preview" method="post">

    <input type="hidden" name="data_json" id="data_json">

    <div id="items-container"></div>

    <button type="button" onclick="addItem()">➕ Добавить товар</button>
    <br><br>
    <button type="submit">Рассчитать</button>
</form>

<script>
// Добавление нового товара
function addItem() {
    const container = document.getElementById("items-container");
    const index = container.children.length;

    const block = document.createElement("div");
    block.className = "item-block";

    block.innerHTML = `
        <h3>Товар №${index + 1}</h3>

        <label>Тип изделия:</label>
        <select class="product_key">
            {% for key, p in products.items() %}
                <option value="{{ key }}">{{ p.label }}</option>
            {% endfor %}
        </select>

        <label>Ширина (мм):</label>
        <input type="number" class="width_mm" value="">

        <label>Высота (мм):</label>
        <input type="number" class="height_mm" value="">

        <label>Количество:</label>
        <input type="number" class="quantity" value="1">

        <label><input type="checkbox" class="opt_edge"> Обработка кромки</label>
        <label><input type="checkbox" class="opt_film"> Противоосколочная плёнка</label>
        <label><input type="checkbox" class="opt_drill"> Сверление</label>

        <label>Кол-во отверстий:</label>
        <input type="number" class="opt_drill_qty" value="0">

        <label><input type="checkbox" class="opt_pack"> Упаковка в гофрокартон</label>
        <label><input type="checkbox" class="opt_mount"> Монтаж (ориентировочно)</label>

        <hr>
    `;

    container.appendChild(block);
}

// Формирование JSON перед отправкой
document.getElementById("calc-form").addEventListener("submit", function(e) {
    const blocks = document.querySelectorAll(".item-block");

    const items = [];

    blocks.forEach(block => {
        items.push({
            product_key: block.querySelector(".product_key").value,
            width_mm: Number(block.querySelector(".width_mm").value),
            height_mm: Number(block.querySelector(".height_mm").value),
            quantity: Number(block.querySelector(".quantity").value),
            options: {
                edge: block.querySelector(".opt_edge").checked,
                film: block.querySelector(".opt_film").checked,
                drill: block.querySelector(".opt_drill").checked,
                drill_qty: Number(block.querySelector(".opt_drill_qty").value),
                pack: block.querySelector(".opt_pack").checked,
                mount: block.querySelector(".opt_mount").checked
            }
        });
    });

    const payload = { items: items };

    document.getElementById("data_json").value = JSON.stringify(payload);
});
</script>

</body>
</html>